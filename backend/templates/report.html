<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MarketLens Report</title>
    <style>
      body { font-family: Arial, sans-serif; background: #131722; color: #d1d4dc; }
      h1, h2, h3 { color: #f7f7f7; }
      .section { margin-bottom: 18px; }
      .badge { padding: 4px 8px; border-radius: 4px; display: inline-block; }
      .bullish { background: #26a69a; color: #fff; }
      .bearish { background: #ef5350; color: #fff; }
      .neutral { background: #78909c; color: #fff; }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border: 1px solid #2a2e39; padding: 6px; text-align: left; }
      .muted { color: #9aa0a6; }
    </style>
  </head>
  <body>
    <div class="section">
      <h1>MarketLens Report - {{ ticker }}</h1>
      <div class="muted">Generated: {{ generated_at }}</div>
    </div>

    <div class="section">
      <h2>Executive Summary</h2>
      {% set badge_class = "neutral" %}
      {% if signal == "BULLISH" %}{% set badge_class = "bullish" %}{% endif %}
      {% if signal == "BEARISH" %}{% set badge_class = "bearish" %}{% endif %}
      <div class="badge {{ badge_class }}">{{ signal }} ({{ confidence }})</div>
      <p><strong>Thesis:</strong> {{ thesis }}</p>
      <p>{{ summary }}</p>
    </div>

    <div class="section">
      <h2>Chart</h2>
      <img src="data:image/png;base64,{{ chart_base64 }}" width="600" />
    </div>

    <div class="section">
      <h2>Detailed Analysis</h2>
      <h3>Trend</h3>
      <p>{{ detailed_analysis.trend }}</p>
      <h3>Momentum</h3>
      <p>{{ detailed_analysis.momentum }}</p>
      <h3>Key Levels</h3>
      <p>{{ detailed_analysis.key_levels }}</p>
      <h3>Volume Context</h3>
      <p>{{ detailed_analysis.volume_context }}</p>
      <h3>Market Context</h3>
      <p>{{ detailed_analysis.market_context }}</p>
    </div>

    <div class="section">
      <h2>Key Levels</h2>
      <table>
        <tr><th>Support</th><th>Resistance</th><th>Stop Loss</th><th>Target</th></tr>
        <tr>
          <td>{{ key_levels.support | join(", ") }}</td>
          <td>{{ key_levels.resistance | join(", ") }}</td>
          <td>{{ key_levels.stop_loss }}</td>
          <td>{{ key_levels.target }}</td>
        </tr>
      </table>
    </div>

    <div class="section">
      <h2>Evidence Chain</h2>
      <ol>
        {% for item in evidence_chain %}
        <li>{{ item }}</li>
        {% endfor %}
      </ol>
    </div>

    <div class="section">
      <h2>Risk Factors</h2>
      <ul>
        {% for item in risk_factors %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <h2>Agent Reasoning Summary</h2>
      <ol>
        {% for step in reasoning_trace %}
        <li>{{ step.type }} - {{ step.content or step.tool_name or "" }}</li>
        {% endfor %}
      </ol>
    </div>

    <div class="section muted">
      <p>Disclaimer: This analysis is for informational purposes only and not investment advice.</p>
    </div>
  </body>
</html>
